(window.webpackJsonp=window.webpackJsonp||[]).push([[179],{1422:function(t,s,a){t.exports=a.p+"assets/img/2.41affead.jpg"},1423:function(t,s,a){t.exports=a.p+"assets/img/4.960425e3.png"},1424:function(t,s,a){t.exports=a.p+"assets/img/3.cb9dd0c5.png"},3232:function(t,s,a){"use strict";a.r(s);var n=a(2),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h2",{attrs:{id:"前话"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前话"}},[t._v("#")]),t._v(" 前话")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("WebSocket 复用了 HTTP 的握手通道")])]),t._v(" "),n("li",[n("p",[t._v("具体指的是,客户端通过 HTTP 请求与 WebSocket 服务端协商升级协议")])]),t._v(" "),n("li",[n("p",[t._v("协议升级完成后,后续的数据交换则遵照 WebSocket 的协议")])]),t._v(" "),n("li",[n("ol",[n("li",[t._v("虚拟以上是 HTTP 协议，客户端需要先与服务器端进行握手，跟服务器端说我要升级成 websocket 协议")])])]),t._v(" "),n("li",[n("ol",{attrs:{start:"2"}},[n("li",[t._v("随后服务器端发送状态码，比如 101 （表示服务器端同意客户端升级成 websocket 协议）")])])]),t._v(" "),n("li",[n("ol",{attrs:{start:"3"}},[n("li",[t._v("随后就是虚线一下的了，比如客户端给服务器发消息, 并且服务器端也可以主动给客户端发送消息")])])]),t._v(" "),n("li",[n("p",[n("img",{attrs:{src:a(1422),alt:""}})])])]),t._v(" "),n("blockquote",[n("p",[t._v("通过抓包得出如下的结果\n"),n("img",{attrs:{src:a(1423),alt:""}})])]),t._v(" "),n("h2",{attrs:{id:"请求头与响应头分析"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#请求头与响应头分析"}},[t._v("#")]),t._v(" 请求头与响应头分析")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("首先客户端发起协议升级请求")])]),t._v(" "),n("li",[n("p",[t._v("请求采用的是标准的 HTTP 报文格式，且只支持 GET 方法")])]),t._v(" "),n("li",[n("p",[t._v("可以通过上一篇文章的实战中的浏览器看到如下的信息:")]),t._v(" "),n("ul",[n("li",[n("ol",{attrs:{start:"0"}},[n("li",[t._v("HTTP/1.1 101 Switching Protocols # 切换协议")])])]),t._v(" "),n("li",[n("ol",[n("li",[t._v("请求头中的 See-Websocket-Version 是 websocket 的版本，目前主流的版本是 13")])])]),t._v(" "),n("li",[n("ol",{attrs:{start:"2"}},[n("li",[t._v("请求头中的 See-Websocket-Key 是客户端随机生成的一个字段串，主要用来加密的, 简单的理解就是会把该字符串发给服务器端，看服务器端能否解析出来，与后面服务端响应首部的 Sec-WebSocket-Accept 是配套的，提供基本的防护，比如恶意的连接，或者无意义的连接")])])]),t._v(" "),n("li",[n("ol",{attrs:{start:"3"}},[n("li",[t._v("响应头中的 Connection: Upgrade 表示同意升级")])])]),t._v(" "),n("li",[n("ol",{attrs:{start:"4"}},[n("li",[t._v("响应头中的 Upgrade: websocket 表示升级成 websocket 协议")])])]),t._v(" "),n("li",[n("ol",{attrs:{start:"4"}},[n("li",[t._v("响应头中的 Sec-Websocket-Accept 的值是跟请求头的 See-Websocket-Key 是有关系的")])])]),t._v(" "),n("li",[n("img",{attrs:{src:a(1424),alt:""}})])])])]),t._v(" "),n("h2",{attrs:{id:"sec-websocket-accept-的计算"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#sec-websocket-accept-的计算"}},[t._v("#")]),t._v(" Sec-WebSocket-Accept 的计算")]),t._v(" "),n("ul",[n("li",[t._v("Sec-WebSocket-Accept 根据客户端请求首部的 Sec-WebSocket-Key 计算出来")]),t._v(" "),n("li",[t._v("计算公式为：\n"),n("ul",[n("li",[t._v("将 Sec-WebSocket-Key 跟 258EAFA5-E914-47DA-95CA-C5AB0DC85B11 拼接")]),t._v(" "),n("li",[t._v("通过 SHA1 计算出摘要，并转成 base64 字符串")])])])]),t._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// crypto 是node中加密的模块")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" crypto "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"crypto"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// CODE 是定死的")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CODE")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("toAcceptKey")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("wsKey")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// md5 是哈希算法")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// sha1 也是一个哈希算法")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// update() 表示升级")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// digest() 表示摘要, 即转成 base64 字符串")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" crypto\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("createHash")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sha1"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("update")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("wsKey "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("CODE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("digest")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"base64"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" webSocketKey "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0QYX2pBoTmuB57jRdt4ffw=="')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("toAcceptKey")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("webSocketKey"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 输出：EqYqZZx0/LlYOk0nBdgZA0yuvmE=")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br")])])])}),[],!1,null,null,null);s.default=e.exports}}]);
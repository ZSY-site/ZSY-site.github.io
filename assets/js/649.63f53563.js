(window.webpackJsonp=window.webpackJsonp||[]).push([[649],{2396:function(t,r,_){"use strict";_.r(r);var e=_(2),v=Object(e.a)({},(function(){var t=this,r=t.$createElement,_=t._self._c||r;return _("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[_("p",[t._v("Title")]),t._v(" "),_("h1",{attrs:{id:"第十七课-并发更新的原理"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#第十七课-并发更新的原理"}},[t._v("#")]),t._v(" 第十七课：并发更新的原理")]),t._v(" "),_("p",[_("a",{attrs:{href:"https://github.com/BetaSu/big-react/commit/f778d20be5a99ea05c1daff9992dfd30c14aed69",target:"_blank",rel:"noopener noreferrer"}},[t._v("本节课代码地址"),_("OutboundLink")],1)]),t._v(" "),_("p",[t._v("本节课对标**「React 设计原理」**5.1 节。")]),t._v(" "),_("p",[t._v("思考一个问题：我们当前的实现是如何驱动的？")]),t._v(" "),_("ol",[_("li",[t._v("交互触发更新")]),t._v(" "),_("li",[t._v("调度阶段微任务调度（"),_("code",[t._v("ensureRootIsScheduled")]),t._v("方法）")]),t._v(" "),_("li",[t._v("微任务调度结束，进入"),_("code",[t._v("render")]),t._v("阶段")]),t._v(" "),_("li",[_("code",[t._v("render")]),t._v("阶段结束，进入"),_("code",[t._v("commit")]),t._v("阶段")]),t._v(" "),_("li",[_("code",[t._v("commit")]),t._v("阶段结束，调度阶段微任务调度（"),_("code",[t._v("ensureRootIsScheduled")]),t._v("方法）")])]),t._v(" "),_("p",[t._v("整体是个大的微任务循环，循环的驱动力是**「微任务调度模块」**。")]),t._v(" "),_("h2",{attrs:{id:"同步示例"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#同步示例"}},[t._v("#")]),t._v(" 同步示例")]),t._v(" "),_("p",[_("img",{attrs:{src:"https://wechatapppro-1252524126.file.myqcloud.com/appjiz2zqrn2142/image/b_u_622f2474a891b_tuQ1ZmhR/ldpq4icj0idm.png",alt:""}})]),t._v(" "),_("p",[t._v("示例在两种情况下会造成阻塞：")]),t._v(" "),_("ul",[_("li",[_("code",[t._v("work.count")]),t._v("数量太多")]),t._v(" "),_("li",[t._v("单个"),_("code",[t._v("work.count")]),t._v("工作量太大")])]),t._v(" "),_("h2",{attrs:{id:"并发更新的理论基础"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#并发更新的理论基础"}},[t._v("#")]),t._v(" 并发更新的理论基础")]),t._v(" "),_("p",[t._v("并发更新的基础是**「时间切片」**。")]),t._v(" "),_("p",[_("a",{attrs:{href:"https://codesandbox.io/s/concurrent-3h48s?file=/src/index.js",target:"_blank",rel:"noopener noreferrer"}},[t._v("在线示例"),_("OutboundLink")],1)]),t._v(" "),_("h2",{attrs:{id:"改造示例"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#改造示例"}},[t._v("#")]),t._v(" 改造示例")]),t._v(" "),_("p",[t._v("如果我们想在宏任务中完成任务调度，本质上是个大的宏任务循环，循环的驱动力是"),_("code",[t._v("Scheduler")]),t._v("。")]),t._v(" "),_("blockquote",[_("p",[t._v("理论基础参考《React 设计原理》")])]),t._v(" "),_("p",[t._v("在微任务调度中，没有**「优先级」**的概念，对于"),_("code",[t._v("Scheduler")]),t._v("存在 5 种优先级：")]),t._v(" "),_("ul",[_("li",[t._v("ImmediatePriority")]),t._v(" "),_("li",[t._v("UserBlockingPriority")]),t._v(" "),_("li",[t._v("NormalPriority")]),t._v(" "),_("li",[t._v("LowPriority")]),t._v(" "),_("li",[t._v("IdlePriority")])]),t._v(" "),_("p",[_("img",{attrs:{src:"https://wechatapppro-1252524126.file.myqcloud.com/appjiz2zqrn2142/image/b_u_622f2474a891b_tuQ1ZmhR/ldpq4icj0xhj.png",alt:""}})]),t._v(" "),_("p",[t._v("需要考虑的情况：")]),t._v(" "),_("h3",{attrs:{id:"工作过程仅有一个-work"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#工作过程仅有一个-work"}},[t._v("#")]),t._v(" 工作过程仅有一个 work")]),t._v(" "),_("p",[t._v("如果仅有一个"),_("code",[t._v("work")]),t._v("，"),_("code",[t._v("Scheduler")]),t._v("有个优化路径：如果调度的回调函数的返回值是函数，则会继续调度返回的函数。")]),t._v(" "),_("h3",{attrs:{id:"工作过程中产生相同优先级的-work"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#工作过程中产生相同优先级的-work"}},[t._v("#")]),t._v(" 工作过程中产生相同优先级的 work")]),t._v(" "),_("p",[t._v("如果优先级相同，则不需要开启新的调度。")]),t._v(" "),_("h3",{attrs:{id:"工作过程中产生更高-低优先级的-work"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#工作过程中产生更高-低优先级的-work"}},[t._v("#")]),t._v(" 工作过程中产生更高/低优先级的 work")]),t._v(" "),_("p",[t._v("把握一个原则：我们每次选出的都是优先级最高的"),_("code",[t._v("work")]),t._v("。")])])}),[],!1,null,null,null);r.default=v.exports}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{1131:function(s,a,n){s.exports=n.p+"assets/img/64.10f2c6e0.png"},1132:function(s,a,n){s.exports=n.p+"assets/img/65.68fa7583.png"},1133:function(s,a,n){s.exports=n.p+"assets/img/66.33d7748b.png"},1134:function(s,a,n){s.exports=n.p+"assets/img/67.15a85eb6.png"},1135:function(s,a,n){s.exports=n.p+"assets/img/68.206dc486.png"},1136:function(s,a,n){s.exports=n.p+"assets/img/69.febc9be9.png"},1137:function(s,a,n){s.exports=n.p+"assets/img/70.3decdc9f.png"},1138:function(s,a,n){s.exports=n.p+"assets/img/71.85a06c16.png"},1139:function(s,a,n){s.exports=n.p+"assets/img/72.2cd3b776.png"},2718:function(s,a,n){"use strict";n.r(a);var t=n(2),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"概述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),t("p",[s._v("开源软件 cAdvisor（Container Advisor）用于监控所在节点的容器运行状态，当前已经\n被默认集成到 kubelet 组件内，默认使用 tcp 4194 端口。在大规模容器集群，一般使用\nHeapster+Influxdb+Grafana 平台实现集群性能数据的采集，存储与展示。")]),s._v(" "),t("h2",{attrs:{id:"环境准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#环境准备"}},[s._v("#")]),s._v(" 环境准备")]),s._v(" "),t("h3",{attrs:{id:"基础环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基础环境"}},[s._v("#")]),s._v(" 基础环境")]),s._v(" "),t("p",[s._v("Kubernetes + heapster + Influxdb + grafana")]),s._v(" "),t("h3",{attrs:{id:"原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[s._v("#")]),s._v(" 原理")]),s._v(" "),t("p",[t("img",{attrs:{src:n(1131),alt:""}}),s._v("\nHeapster：集群中各 node 节点的 cAdvisor 的数据采集汇聚系统，通过调用 node 上\nkubelet 的 api，再通过 kubelet 调用 cAdvisor 的 api 来采集所在节点上所有容器的性能\n数据。Heapster 对性能数据进行聚合，并将结果保存到后端存储系统，heapster 支持多种\n后端存储系统，如 memory，Influxdb 等。\nInfluxdb：分布式时序数据库（每条记录有带有时间戳属性），主要用于实时数据采集，\n时间跟踪记录，存储时间图表，原始数据等。Influxdb 提供 rest api 用于数据的存储与\n查询。\nGrafana：通过 dashboard 将 Influxdb 中的时序数据展现成图表或曲线等形式，便于查看\n集群运行状态。\nHeapster，Influxdb，Grafana 均以 Pod 的形式启动与运行。")]),s._v(" "),t("h2",{attrs:{id:"部署-kubernetes-集群性能监控"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#部署-kubernetes-集群性能监控"}},[s._v("#")]),s._v(" 部署 Kubernetes 集群性能监控")]),s._v(" "),t("h3",{attrs:{id:"准备-images"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#准备-images"}},[s._v("#")]),s._v(" 准备 images")]),s._v(" "),t("p",[s._v('kubernetes 部署服务时，为避免部署时发生 pull 镜像超时的问题，建议提前将相关镜像\npull 到相关所有节点（以下以 kubenode1 为例），或搭建本地镜像系统。\n需要从 gcr.io pull 的镜像，已利用 Docker Hub 的"Create Auto-Build GitHub"功能\n（Docker Hub 利用 GitHub 上的 Dockerfile 文件 build 镜像），在个人的 Docker Hub\nbuild 成功，可直接 pull 到本地使用。')]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# heapster")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker pull netonline/heapster-amd64:v1.5.1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# influxdb")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker pull netonline/heapster-influxdb-amd64:v1.3.3")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# grafana")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker pull netonline/heapster-grafana-amd64:v4.4.3")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h3",{attrs:{id:"下载-yaml-范本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#下载-yaml-范本"}},[s._v("#")]),s._v(" 下载 yaml 范本")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# release 下载页：https://github.com/kubernetes/heapster/releases")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# release 中的 yaml 范本有时较")]),s._v("\nhttps://github.com/kubernetes/heapster/tree/master/deploy/kube-config/influxdb\n的 yaml 新，但区别不大\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /usr/local/src/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 src"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# wget -O heapster-v1.5.1.tar.gz")]),s._v("\nhttps://github.com/kubernetes/heapster/archive/v1.5.1.tar.gz\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# yaml 范本在 heapster/deploy/kube-config/influxdb 目录，另有 1 个 heapsterrbac.yaml 在 heapster/deploy/kube-config/rbac 目录，两者目录结构同 github")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 src"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# tar -zxvf heapster-v1.5.1.tar.gz -C /usr/local/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 src"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv /usr/local/heapster-1.5.1 /usr/local/heapster")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h3",{attrs:{id:"heapster-rbac-yaml"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#heapster-rbac-yaml"}},[s._v("#")]),s._v(" heapster-rbac.yaml")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# heapster 需要向 kubernetes-master 请求 node 列表，需要设置相应权限；")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认不需要对 heapster-rbac.yaml 修改，将 kubernetes 集群自带的 ClusterRole ：")]),s._v("\nsystem"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("heapster 做 ClusterRoleBinding，完成授权\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /usr/local/heapster/deploy/kube-config/rbac/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 rbac"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat heapster-rbac.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterRoleBinding\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io/v1beta1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" heapster\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roleRef")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiGroup")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterRole\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" system"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("heapster\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("subjects")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ServiceAccount\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" heapster\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("h3",{attrs:{id:"heapster-yaml"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#heapster-yaml"}},[s._v("#")]),s._v(" heapster.yaml")]),s._v(" "),t("p",[s._v("hepster.yaml 由 3 个模块组成：ServiceAccout，Deployment，Service。\n1）ServiceAccount\n默认不需要修改 ServiceAccount 部分，设置 ServiceAccount 资源，获取 rbac 中定义的权\n限。\n2）Deployment")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改处：第 23 行，变更镜像名；")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --source：配置采集源，使用安全端口调用 kubernetes 集群 api；")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# --sink：配置后端存储为 influxdb；地址采用 influxdb 的 service 名，需要集群 dns")]),s._v("\n正常工作，如果没有配置 dns 服务，可使用 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" 的 ClusterIP 地址\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /usr/local/heapster/deploy/kube-config/influxdb/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 influxdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sed -i 's|gcr.io/google_containers/heapsteramd64:v1.5.1|netonline/heapster-amd64:v1.5.1|g' heapster.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 influxdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat heapster.yaml ……")]),s._v("\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\nname: heapster\nnamespace: kube-system\nspec:\nreplicas: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\ntemplate:\nmetadata:\nlabels:\ntask: monitoring\nk8s-app: heapster\nspec:\nserviceAccountName: heapster\ncontainers:\n- name: heapster\nimage: netonline/heapster-amd64:v1.5.1\nimagePullPolicy: IfNotPresent\ncommand:\n- /heapster\n- "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--source")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes:https://kubernetes.default\n- "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--sink")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("influxdb:http://monitoring-influxdb.kube-system.svc:8086\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br")])]),t("p",[s._v("3）Service\n默认不需要修改 Service 部分。")]),s._v(" "),t("h3",{attrs:{id:"influxdb-yaml"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#influxdb-yaml"}},[s._v("#")]),s._v(" influxdb.yaml")]),s._v(" "),t("p",[s._v("influxdb.yaml 由 2 个模块组成：Deployment，Service。\n1）Deployment")]),s._v(" "),t("ul",[t("li",[s._v("修改处：第 16 行，变更镜像名；\n[root@kubenode1 influxdb]# sed -i 's|gcr.io/google_containers/heapsterinfluxdb-amd64:v1.3.3|netonline/heapster-influxdb-amd64:v1.3.3|g'\ninfluxdb.yaml")])]),s._v(" "),t("p",[s._v("2）Service\n默认不需要修改 Service 部分，注意 Service 名字的对应即可。")]),s._v(" "),t("h3",{attrs:{id:"grafana-yaml"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#grafana-yaml"}},[s._v("#")]),s._v(" grafana.yaml")]),s._v(" "),t("p",[s._v("grafana.yaml 由 2 个模块组成：Deployment，Service。\n1）Deployment")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改处：第 16 行，变更镜像名；")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改处：第 43 行，取消注释；“GF_SERVER_ROOT_URL”的 value 值设定后，只能通过")]),s._v("\nAPI Server proxy 访问 grafana；\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改处：第 44 行，注释本行；")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# INFLUXDB_HOST 的 value 值设定为 influxdb 的 service 名，依赖于集群 dns，或者直接")]),s._v("\n使用 ClusterIP\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 influxdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sed -i 's|gcr.io/google_containers/heapster-grafanaamd64:v4.4.3|netonline/heapster-grafana-amd64:v4.4.3|g' grafana.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 influxdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sed -i '43s|# value:|value:|g' grafana.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 influxdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sed -i '44s|value:|# value:|g' grafana.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 influxdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat grafana.yaml ……")]),s._v("\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\nname: monitoring-grafana\nnamespace: kube-system\nspec:\nreplicas: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\ntemplate:\nmetadata:\nlabels:\ntask: monitoring\nk8s-app: grafana\nspec:\ncontainers:\n- name: grafana\nimage: netonline/heapster-grafana-amd64:v4.4.3\nports:\n- containerPort: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v("\nprotocol: TCP\nvolumeMounts:\n- mountPath: /etc/ssl/certs\nname: ca-certificates\nreadOnly: "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n- mountPath: /var\nname: grafana-storage\nenv:\n- name: INFLUXDB_HOST\nvalue: monitoring-influxdb\n- name: GF_SERVER_HTTP_PORT\nvalue: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3000"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# The following env variables are required to make Grafana accessible")]),s._v("\nvia\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# the kubernetes api-server proxy. On production clusters, we")]),s._v("\nrecommend\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# removing these env variables, setup auth for grafana, and expose")]),s._v("\nthe grafana\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service using a LoadBalancer or a public IP.")]),s._v("\n- name: GF_AUTH_BASIC_ENABLED\nvalue: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"false"')]),s._v("\n- name: GF_AUTH_ANONYMOUS_ENABLED\nvalue: "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n- name: GF_AUTH_ANONYMOUS_ORG_ROLE\nvalue: Admin\n- name: GF_SERVER_ROOT_URL\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# If you're only using the API Server proxy, set this value instead:")]),s._v("\nvalue: /api/v1/namespaces/kube-system/services/monitoringgrafana/proxy\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# value: /")]),s._v("\nvolumes:\n- name: ca-certificates\nhostPath:\npath: /etc/ssl/certs\n- name: grafana-storage\nemptyDir: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br")])]),t("p",[s._v("2）Service\n默认不需要修改 Service 部分，注意 Service 名字的对应即可。")]),s._v(" "),t("h2",{attrs:{id:"验证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#验证"}},[s._v("#")]),s._v(" 验证")]),s._v(" "),t("h3",{attrs:{id:"启动监控相关服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动监控相关服务"}},[s._v("#")]),s._v(" 启动监控相关服务")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将 heapster-rbac.yaml 复制到 influxdb/目录；")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /usr/local/heapster/deploy/kube-config/influxdb/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 influxdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cp /usr/local/heapster/deploy/kubeconfig/rbac/heapster-rbac.yaml .")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 influxdb"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f .")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[t("img",{attrs:{src:n(1132),alt:""}})]),s._v(" "),t("h3",{attrs:{id:"查看相关服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看相关服务"}},[s._v("#")]),s._v(" 查看相关服务")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看 deployment 与 Pod 运行状态")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get deploy -n kube-system | grep -E")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'heapster|monitoring'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods -n kube-system | grep -E")]),s._v("\n'heapster"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("monitoring\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[t("img",{attrs:{src:n(1133),alt:""}})]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看 service 运行状态")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc -n kube-system | grep -E")]),s._v("\n'heapster"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("monitoring\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[t("img",{attrs:{src:n(1134),alt:""}})]),s._v(" "),t("h3",{attrs:{id:"访问-dashboard"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#访问-dashboard"}},[s._v("#")]),s._v(" 访问 dashboard")]),s._v(" "),t("p",[s._v("浏览器访问访问 dashboard：https://172.30.200.10:6443/api/v1/namespaces/kubesystem/services/https:kubernetes-dashboard:/proxy\n注意：Dasheboard 没有配置 hepster 监控平台时，不能展示 node，Pod 资源的 CPU 与内存\n等 metric 图形\nNode 资源 CPU/内存 metric 图形：")]),s._v(" "),t("p",[t("img",{attrs:{src:n(1135),alt:""}})]),s._v(" "),t("p",[s._v("Pod 资源 CPU/内存 metric 图形：\n"),t("img",{attrs:{src:n(1136),alt:""}})]),s._v(" "),t("h3",{attrs:{id:"访问-grafana"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#访问-grafana"}},[s._v("#")]),s._v(" 访问 grafana")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过 kube-apiserver 访问")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@kubenode1 ~"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl cluster-info")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("img",{attrs:{src:n(1137),alt:""}}),s._v("\n浏览器访问访问 dashboard：https://172.30.200.10:6443/api/v1/namespaces/kubesystem/services/monitoring-grafana/proxy\n集群节点信息：")]),s._v(" "),t("p",[t("img",{attrs:{src:n(1138),alt:""}})]),s._v(" "),t("p",[s._v("Pod 信息：")]),s._v(" "),t("p",[t("img",{attrs:{src:n(1139),alt:""}})])])}),[],!1,null,null,null);a.default=e.exports}}]);
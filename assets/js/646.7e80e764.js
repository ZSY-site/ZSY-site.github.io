(window.webpackJsonp=window.webpackJsonp||[]).push([[646],{2395:function(e,t,_){"use strict";_.r(t);var v=_(2),a=Object(v.a)({},(function(){var e=this,t=e.$createElement,_=e._self._c||t;return _("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[_("p",[e._v("Title")]),e._v(" "),_("p",[e._v("课前须知：")]),e._v(" "),_("ul",[_("li",[e._v("为了更好的学习体验，请购课后加卡颂微信（kasong555），发送课程购买截图，拉你进专属学习群")]),e._v(" "),_("li",[e._v("参与"),_("a",{attrs:{href:"https://wj.qq.com/s2/11444184/b3e4/",target:"_blank",rel:"noopener noreferrer"}},[e._v("2 个月通关 React 挑战"),_("OutboundLink")],1),e._v("，返现金")]),e._v(" "),_("li",[_("a",{attrs:{href:"https://github.com/BetaSu/big-react/commit/b77e05c54ff49039c9872971dfd10069c4f05730",target:"_blank",rel:"noopener noreferrer"}},[e._v("本节课代码地址"),_("OutboundLink")],1)])]),e._v(" "),_("h1",{attrs:{id:"第十四课-实现同步调度流程"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#第十四课-实现同步调度流程"}},[e._v("#")]),e._v(" 第十四课：实现同步调度流程")]),e._v(" "),_("p",[e._v("更新到底是同步还是异步？")]),e._v(" "),_("p",[_("code",[e._v("class App extends React.Component { onClick() { this.setState({a: 1}); console.log(this.state.a); } // ...省略其他代码 }")])]),e._v(" "),_("p",[e._v("当前的现状：")]),e._v(" "),_("ul",[_("li",[e._v("从触发更新到"),_("code",[e._v("render")]),e._v("，再到"),_("code",[e._v("commit")]),e._v("都是同步的")]),e._v(" "),_("li",[e._v("多次触发更新会重复多次更新流程")])]),e._v(" "),_("p",[e._v("可以改进的地方："),_("strong",[e._v("「多次触发更新，只进行一次更新流程」")])]),e._v(" "),_("p",[_("code",[e._v("Batched Updates")]),e._v("（批处理）：多次触发更新，只进行一次更新流程")]),e._v(" "),_("p",[e._v("将多次更新合并为一次，理念上有点类似防抖、节流，我们需要考虑合并的时机是：")]),e._v(" "),_("ul",[_("li",[e._v("宏任务？")]),e._v(" "),_("li",[e._v("微任务？")])]),e._v(" "),_("p",[e._v("用三款框架实现"),_("code",[e._v("Batched Updates")]),e._v("，打印结果不同：")]),e._v(" "),_("ul",[_("li",[_("a",{attrs:{href:"https://codesandbox.io/s/react-concurrent-mode-demo-forked-t8mil?file=/src/index.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("React"),_("OutboundLink")],1)]),e._v(" "),_("li",[_("a",{attrs:{href:"https://codesandbox.io/s/crazy-rosalind-wqj0c?file=/src/App.vue",target:"_blank",rel:"noopener noreferrer"}},[e._v("Vue3"),_("OutboundLink")],1)]),e._v(" "),_("li",[_("a",{attrs:{href:"https://svelte.dev/repl/1e4e4e44b9ca4e0ebba98ef314cfda54?version=3.44.1",target:"_blank",rel:"noopener noreferrer"}},[e._v("Svelte"),_("OutboundLink")],1)])]),e._v(" "),_("p",[e._v("结论："),_("code",[e._v("React")]),e._v("批处理的时机既有宏任务，也有微任务。")]),e._v(" "),_("p",[e._v("本节课我们来实现**「微任务的批处理」**。")]),e._v(" "),_("h2",{attrs:{id:"新增调度阶段"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#新增调度阶段"}},[e._v("#")]),e._v(" 新增调度阶段")]),e._v(" "),_("p",[e._v("既然我们需要**「多次触发更新，只进行一次更新流程」**，意味着我们要将更新合并，所以在：")]),e._v(" "),_("ul",[_("li",[_("code",[e._v("render")]),e._v("阶段")]),e._v(" "),_("li",[_("code",[e._v("commit")]),e._v("阶段")])]),e._v(" "),_("p",[e._v("的基础上增加"),_("code",[e._v("schedule")]),e._v("阶段（调度阶段）")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://wechatapppro-1252524126.file.myqcloud.com/appjiz2zqrn2142/image/b_u_622f2474a891b_tuQ1ZmhR/lcj6f2cq07p3.png",alt:""}})]),e._v(" "),_("h2",{attrs:{id:"对-update-的调整"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#对-update-的调整"}},[e._v("#")]),e._v(" 对 update 的调整")]),e._v(" "),_("p",[e._v("**「多次触发更新，只进行一次更新流程」"),_("strong",[e._v("中")]),e._v("「多次触发更新」**意味着对于同一个"),_("code",[e._v("fiber")]),e._v("，会创建多个"),_("code",[e._v("update")]),e._v("：")]),e._v(" "),_("p",[_("code",[e._v("const onClick = () => { // 创建3个update updateCount((count) => count + 1); updateCount((count) => count + 1); updateCount((count) => count + 1); };")])]),e._v(" "),_("p",[_("strong",[e._v("「多次触发更新，只进行一次更新流程」")]),e._v("，意味着要达成 3 个目标：")]),e._v(" "),_("ol",[_("li",[e._v("需要实现一套优先级机制，每个更新都拥有优先级")]),e._v(" "),_("li",[e._v("需要能够合并一个宏任务/微任务中触发的所有更新")]),e._v(" "),_("li",[e._v("需要一套算法，用于决定哪个优先级优先进入 render 阶段")])]),e._v(" "),_("p",[_("img",{attrs:{src:"https://wechatapppro-1252524126.file.myqcloud.com/appjiz2zqrn2142/image/b_u_622f2474a891b_tuQ1ZmhR/lcj6f2cq0x2o.png",alt:""}})]),e._v(" "),_("h2",{attrs:{id:"实现目标-1-lane-模型"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#实现目标-1-lane-模型"}},[e._v("#")]),e._v(" 实现目标 1：Lane 模型")]),e._v(" "),_("p",[e._v("包括：")]),e._v(" "),_("ul",[_("li",[_("code",[e._v("lane")]),e._v("（二进制位，代表优先级）")]),e._v(" "),_("li",[_("code",[e._v("lanes")]),e._v("（二进制位，代表"),_("code",[e._v("lane")]),e._v("的集合）")])]),e._v(" "),_("p",[e._v("其中：")]),e._v(" "),_("ul",[_("li",[_("code",[e._v("lane")]),e._v("作为"),_("code",[e._v("update")]),e._v("的优先级")]),e._v(" "),_("li",[_("code",[e._v("lanes")]),e._v("作为"),_("code",[e._v("lane")]),e._v("的集合")])]),e._v(" "),_("h3",{attrs:{id:"lane-的产生"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#lane-的产生"}},[e._v("#")]),e._v(" lane 的产生")]),e._v(" "),_("p",[e._v("对于不同情况触发的更新，产生"),_("code",[e._v("lane")]),e._v("。为后续不同事件产生不同优先级更新做准备。")]),e._v(" "),_("p",[e._v("如何知道哪些"),_("code",[e._v("lane")]),e._v("被消费，还剩哪些"),_("code",[e._v("lane")]),e._v("没被消费？")]),e._v(" "),_("h2",{attrs:{id:"对-fiberrootnode-的改造"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#对-fiberrootnode-的改造"}},[e._v("#")]),e._v(" 对 FiberRootNode 的改造")]),e._v(" "),_("p",[e._v("需要增加如下字段：")]),e._v(" "),_("ul",[_("li",[e._v("代表所有未被消费的"),_("code",[e._v("lane")]),e._v("的集合")]),e._v(" "),_("li",[e._v("代表本次更新消费的"),_("code",[e._v("lane")])])]),e._v(" "),_("p",[_("img",{attrs:{src:"https://wechatapppro-1252524126.file.myqcloud.com/appjiz2zqrn2142/image/b_u_622f2474a891b_tuQ1ZmhR/lcj6f2cr03va.png",alt:""}})]),e._v(" "),_("h2",{attrs:{id:"实现目标-2、3"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#实现目标-2、3"}},[e._v("#")]),e._v(" 实现目标 2、3")]),e._v(" "),_("p",[e._v("需要完成两件事：")]),e._v(" "),_("ul",[_("li",[e._v("实现「某些判断机制」，选出一个"),_("code",[e._v("lane")])]),e._v(" "),_("li",[e._v("实现类似防抖、节流的效果，合并宏/微任务中触发的更新")])]),e._v(" "),_("h2",{attrs:{id:"render-阶段的改造"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#render-阶段的改造"}},[e._v("#")]),e._v(" render 阶段的改造")]),e._v(" "),_("p",[_("code",[e._v("processUpdateQueue")]),e._v("方法消费"),_("code",[e._v("update")]),e._v("时需要考虑：")]),e._v(" "),_("ul",[_("li",[_("code",[e._v("lane")]),e._v("的因素")]),e._v(" "),_("li",[_("code",[e._v("update")]),e._v("现在是一条链表，需要遍历")])]),e._v(" "),_("h2",{attrs:{id:"commit-阶段的改造"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#commit-阶段的改造"}},[e._v("#")]),e._v(" commit 阶段的改造")]),e._v(" "),_("p",[e._v("移除**「本次更新被消费的 lane」**。")])])}),[],!1,null,null,null);t.default=a.exports}}]);
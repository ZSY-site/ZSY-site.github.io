(window.webpackJsonp=window.webpackJsonp||[]).push([[647],{2392:function(e,t,_){"use strict";_.r(t);var v=_(2),c=Object(v.a)({},(function(){var e=this,t=e.$createElement,_=e._self._c||t;return _("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[_("p",[e._v("Title")]),e._v(" "),_("p",[e._v("课前须知：")]),e._v(" "),_("ul",[_("li",[e._v("为了更好的学习体验，请购课后加卡颂微信（kasong555），发送课程购买截图，拉你进专属学习群")]),e._v(" "),_("li",[e._v("参与"),_("a",{attrs:{href:"https://wj.qq.com/s2/11444184/b3e4/",target:"_blank",rel:"noopener noreferrer"}},[e._v("2 个月通关 React 挑战"),_("OutboundLink")],1),e._v("，返现金")]),e._v(" "),_("li",[_("a",{attrs:{href:"https://github.com/BetaSu/big-react/commit/0de1b018924086224c805edde649de6a9a786951",target:"_blank",rel:"noopener noreferrer"}},[e._v("本节课代码地址"),_("OutboundLink")],1)])]),e._v(" "),_("h1",{attrs:{id:"第十五课-实现-useeffect"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#第十五课-实现-useeffect"}},[e._v("#")]),e._v(" 第十五课：实现 useEffect")]),e._v(" "),_("p",[e._v("实现"),_("code",[e._v("useEffect")]),e._v("需要考虑的：")]),e._v(" "),_("ul",[_("li",[_("code",[e._v("effect")]),e._v("数据结构")])]),e._v(" "),_("p",[_("img",{attrs:{src:"https://wechatapppro-1252524126.file.myqcloud.com/appjiz2zqrn2142/image/b_u_622f2474a891b_tuQ1ZmhR/lcwzfvex0vnp.png",alt:""}})]),e._v(" "),_("ul",[_("li",[_("code",[e._v("effect")]),e._v("的工作流程如何接入现有流程")])]),e._v(" "),_("h2",{attrs:{id:"effect-数据结构"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#effect-数据结构"}},[e._v("#")]),e._v(" effect 数据结构")]),e._v(" "),_("p",[e._v("什么是"),_("code",[e._v("effect")]),e._v("？")]),e._v(" "),_("p",[_("code",[e._v("function App() { useEffect(() => { // create return () => { // destroy } }, [xxx, yyy]) useLayoutEffect(() => {}) useEffect(() => {}, []) // ... }")])]),e._v(" "),_("p",[e._v("数据结构需要考虑：")]),e._v(" "),_("ul",[_("li",[_("p",[e._v("不同"),_("code",[e._v("effect")]),e._v("可以共用同一个机制")])]),e._v(" "),_("li",[_("p",[_("code",[e._v("useEffect")])])]),e._v(" "),_("li",[_("p",[_("code",[e._v("useLayoutEffect")])])]),e._v(" "),_("li",[_("p",[_("code",[e._v("useInsertionEffect")])])]),e._v(" "),_("li",[_("p",[e._v("需要能保存依赖")])]),e._v(" "),_("li",[_("p",[e._v("需要能保存"),_("code",[e._v("create")]),e._v("回调")])]),e._v(" "),_("li",[_("p",[e._v("需要能保存"),_("code",[e._v("destroy")]),e._v("回调")])]),e._v(" "),_("li",[_("p",[e._v("需要能够区分是否需要触发"),_("code",[e._v("create")]),e._v("回调")])]),e._v(" "),_("li",[_("p",[_("code",[e._v("mount")]),e._v("时")])]),e._v(" "),_("li",[_("p",[e._v("依赖变化时")])])]),e._v(" "),_("p",[_("code",[e._v("const effect = { tag, create, destroy, deps, next }")])]),e._v(" "),_("p",[e._v("注意区分本节课新增的 3 个"),_("code",[e._v("flag")]),e._v("：")]),e._v(" "),_("ul",[_("li",[e._v("对于"),_("code",[e._v("fiber")]),e._v("，新增"),_("code",[e._v("PassiveEffect")]),e._v("，代表**「当前 fiber 本次更新存在副作用」**")]),e._v(" "),_("li",[e._v("对于"),_("code",[e._v("effect hook")]),e._v("，"),_("code",[e._v("Passive")]),e._v("代表**「useEffect 对应 effect」**")]),e._v(" "),_("li",[e._v("对于"),_("code",[e._v("effect hook")]),e._v("，"),_("code",[e._v("HookHasEffect")]),e._v("代表**「当前 effect 本次更新存在副作用」**")])]),e._v(" "),_("p",[_("img",{attrs:{src:"https://wechatapppro-1252524126.file.myqcloud.com/appjiz2zqrn2142/image/b_u_622f2474a891b_tuQ1ZmhR/lcwzfvex09tw.png",alt:""}})]),e._v(" "),_("ul",[_("li",[e._v("为了方便使用，最好和其他"),_("code",[e._v("effect")]),e._v("连接成链表")])]),e._v(" "),_("p",[_("code",[e._v("render")]),e._v("时重置"),_("code",[e._v("effect")]),e._v("链表")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://wechatapppro-1252524126.file.myqcloud.com/appjiz2zqrn2142/image/b_u_622f2474a891b_tuQ1ZmhR/lcwzfvex0lwm.png",alt:""}})]),e._v(" "),_("h2",{attrs:{id:"effect-的工作流程"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#effect-的工作流程"}},[e._v("#")]),e._v(" effect 的工作流程")]),e._v(" "),_("p",[_("img",{attrs:{src:"https://wechatapppro-1252524126.file.myqcloud.com/appjiz2zqrn2142/image/b_u_622f2474a891b_tuQ1ZmhR/lcwzfvex019k.png",alt:""}})]),e._v(" "),_("h3",{attrs:{id:"调度副作用"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#调度副作用"}},[e._v("#")]),e._v(" 调度副作用")]),e._v(" "),_("p",[e._v("调度需要使用"),_("a",{attrs:{href:"https://www.npmjs.com/package/scheduler",target:"_blank",rel:"noopener noreferrer"}},[e._v("Scheduler"),_("OutboundLink")],1),e._v("（调度器），调度器也属于"),_("a",{attrs:{href:"https://github.com/facebook/react/tree/main/packages/scheduler",target:"_blank",rel:"noopener noreferrer"}},[e._v("React 项目下的模块"),_("OutboundLink")],1),e._v("。在本课程中，我们不会实现调度器，但会教如何使用它。")]),e._v(" "),_("p",[_("code",[e._v("pnpm i -w scheduler pnpm i -D -w @types/scheduler")])]),e._v(" "),_("h3",{attrs:{id:"收集回调"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#收集回调"}},[e._v("#")]),e._v(" 收集回调")]),e._v(" "),_("p",[e._v("回调包括两类：")]),e._v(" "),_("ul",[_("li",[_("code",[e._v("create")]),e._v("回调")]),e._v(" "),_("li",[_("code",[e._v("destroy")]),e._v("回调")])]),e._v(" "),_("p",[_("a",{attrs:{href:"https://codesandbox.io/s/wonderful-davinci-cduo7y?file=/src/App.js:276-336",target:"_blank",rel:"noopener noreferrer"}},[e._v("在线 Demo 地址"),_("OutboundLink")],1)]),e._v(" "),_("p",[_("code",[e._v("function App() { const [num, updateNum] = useState(0); useEffect(() => { console.log('App mount'); }, []); useEffect(() => { console.log('num change create', num); return () => { console.log('num change destroy', num); }; }, [num]); return ( <div onClick={() => updateNum(num + 1)}> {num === 0 ? <Child /> : 'noop'} </div> ); } function Child() { useEffect(() => { console.log('Child mount'); return () => console.log('Child unmount'); }, []); return 'i am child'; }")])]),e._v(" "),_("p",[e._v("这意味着我们需要收集两类回调：")]),e._v(" "),_("ul",[_("li",[_("code",[e._v("unmout")]),e._v("时执行的"),_("code",[e._v("destroy")]),e._v("回调")]),e._v(" "),_("li",[_("code",[e._v("update")]),e._v("时执行的"),_("code",[e._v("create")]),e._v("回调")])]),e._v(" "),_("h3",{attrs:{id:"执行副作用"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#执行副作用"}},[e._v("#")]),e._v(" 执行副作用")]),e._v(" "),_("p",[e._v("本次更新的任何"),_("code",[e._v("create")]),e._v("回调都必须在所有上一次更新的"),_("code",[e._v("destroy")]),e._v("回调执行完后再执行。")]),e._v(" "),_("p",[e._v("整体执行流程包括：")]),e._v(" "),_("ol",[_("li",[e._v("遍历"),_("code",[e._v("effect")])]),e._v(" "),_("li",[e._v("首先触发所有"),_("code",[e._v("unmount effect")]),e._v("，且对于某个"),_("code",[e._v("fiber")]),e._v("，如果触发了"),_("code",[e._v("unmount destroy")]),e._v("，本次更新不会再触发"),_("code",[e._v("update create")])]),e._v(" "),_("li",[e._v("触发所有上次更新的"),_("code",[e._v("destroy")])]),e._v(" "),_("li",[e._v("触发所有这次更新的"),_("code",[e._v("create")])])]),e._v(" "),_("p",[_("code",[e._v("mount")]),e._v("、"),_("code",[e._v("update")]),e._v("时的区别")]),e._v(" "),_("ul",[_("li",[_("code",[e._v("mount")]),e._v("时：一定标记"),_("code",[e._v("PassiveEffect")])]),e._v(" "),_("li",[_("code",[e._v("update")]),e._v("时："),_("code",[e._v("deps")]),e._v("变化时标记"),_("code",[e._v("PassiveEffect")])])])])}),[],!1,null,null,null);t.default=c.exports}}]);
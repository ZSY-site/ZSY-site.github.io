(window.webpackJsonp=window.webpackJsonp||[]).push([[894],{2726:function(s,a,e){"use strict";e.r(a);var t=e(2),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h2",{attrs:{id:"安装要求"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装要求"}},[s._v("#")]),s._v(" 安装要求")]),s._v(" "),e("p",[s._v("在开始之前，部署 Kubernetes 集群机器需要满足以下几个条件：\n（1）一台或多台机器，操作系统 CentOS7.x-86_x64\n（2）硬件配置：2GB 或更多 RAM，2 个 CPU 或更多 CPU，硬盘 30GB 或更多\n（3）集群中所有机器之间网络互通\n（4）可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像并导入节点\n（5）禁止 swap 分区")]),s._v(" "),e("h2",{attrs:{id:"准备环境"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#准备环境"}},[s._v("#")]),s._v(" 准备环境")]),s._v(" "),e("p",[s._v("（1）软件环境：")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("软件")]),s._v(" "),e("th",[s._v("版本")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("操作系统")]),s._v(" "),e("td",[s._v("CentOS7.8_x64 （mini）")])]),s._v(" "),e("tr",[e("td",[s._v("Docker")]),s._v(" "),e("td",[s._v("19-ce")])]),s._v(" "),e("tr",[e("td",[s._v("Kubernetes")]),s._v(" "),e("td",[s._v("1.19")])])])]),s._v(" "),e("p",[s._v("（2）服务器规划：")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("角色")]),s._v(" "),e("th",[s._v("IP")]),s._v(" "),e("th",[s._v("组件")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("k8s-master")]),s._v(" "),e("td",[s._v("192.168.31.71")]),s._v(" "),e("td",[s._v("kube-apiserver，kube-controller-manager，kube")])]),s._v(" "),e("tr",[e("td",[s._v("-scheduler，etcd")]),s._v(" "),e("td"),s._v(" "),e("td")]),s._v(" "),e("tr",[e("td",[s._v("k8s-node1")]),s._v(" "),e("td",[s._v("192.168.31.72")]),s._v(" "),e("td",[s._v("kubelet，kube-proxy，docker etcd")])]),s._v(" "),e("tr",[e("td",[s._v("k8s-node2")]),s._v(" "),e("td",[s._v("192.168.31.73")]),s._v(" "),e("td",[s._v("kubelet，kube-proxy，docker，etcd")])])])]),s._v(" "),e("h2",{attrs:{id:"操作系统初始化配"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#操作系统初始化配"}},[s._v("#")]),s._v(" 操作系统初始化配")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭防火墙")]),s._v("\nsystemctl stop firewalld\nsystemctl disable firewalld\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭 selinux")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/enforcing/disabled/'")]),s._v(" /etc/selinux/config "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 永久")]),s._v("\nsetenforce "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 临时")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭 swap")]),s._v("\nswapoff "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-a")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 临时")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ri")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s/.*swap.*/#&/'")]),s._v(" /etc/fstab "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 永久")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 根据规划设置主机名")]),s._v("\nhostnamectl set-hostname "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("hostname"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在 master 添加 hosts")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/hosts "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n192.168.44.147 m1\n192.168.44.148 n1\nEOF")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将桥接的 IPv4 流量传递到 iptables 的链")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/sysctl.d/k8s.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nEOF")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sysctl")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--system")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生效")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 时间同步")]),s._v("\nyum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" ntpdate "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\nntpdate time.windows.com\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br")])]),e("h2",{attrs:{id:"部署-etcd-集群"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-etcd-集群"}},[s._v("#")]),s._v(" 部署 Etcd 集群")]),s._v(" "),e("p",[s._v("Etcd 是一个分布式键值存储系统，Kubernetes 使用 Etcd 进行数据存储，所以先准备\n一个 Etcd 数据库，为解决 Etcd 单点故障，应采用集群方式部署，这里使用 3 台组建集\n群，可容忍 1 台机器故障，当然，你也可以使用 5 台组建集群，可容忍 2 台机器故障。")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("节点名称")]),s._v(" "),e("th",[s._v("IP")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("etcd-1")]),s._v(" "),e("td",[s._v("192.168.31.71")])]),s._v(" "),e("tr",[e("td",[s._v("etcd-2")]),s._v(" "),e("td",[s._v("192.168.31.72")])]),s._v(" "),e("tr",[e("td",[s._v("etcd-3")]),s._v(" "),e("td",[s._v("192.168.31.73")])])])]),s._v(" "),e("p",[s._v("注：为了节省机器，这里与 K8s 节点机器复用。也可以独立于 k8s 集群之外部署，只要\napiserver 能连接到就行。")]),s._v(" "),e("h3",{attrs:{id:"准备-cfssl-证书生成工具"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#准备-cfssl-证书生成工具"}},[s._v("#")]),s._v(" 准备 cfssl 证书生成工具")]),s._v(" "),e("p",[s._v("cfssl 是一个开源的证书管理工具，使用 json 文件生成证书，相比 openssl 更方便使用。\n找任意一台服务器操作，这里用 Master 节点。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://pkg.cfssl.org/R1.2/cfssl_linux-amd64\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" cfssl_linux-amd64 /usr/local/bin/cfssl\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" cfssljson_linux-amd64 /usr/local/bin/cfssljson\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("h3",{attrs:{id:"生成-etcd-证书"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#生成-etcd-证书"}},[s._v("#")]),s._v(" 生成 Etcd 证书")]),s._v(" "),e("p",[s._v("（1）自签证书颁发机构（CA）\n创建工作目录：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" ~/TLS/"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("etcd,k8s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" TLS/etcd\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("自签 CA：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ca-config.json"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n"signing": {\n"default": {\n"expiry": "87600h"\n},\n"profiles": {\n"www": {\n"expiry": "87600h",\n"usages": [\n"signing",\n"key encipherment",\n"server auth",\n"client auth"\n]\n}\n}\n}\n}\nEOF')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ca-csr.json"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n"CN": "etcd CA",\n"key": {\n"algo": "rsa",\n"size": 2048\n},\n"names": [\n{\n"C": "CN",\n"L": "Beijing",\n"ST": "Beijing"\n}\n]\n}\nEOF')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br")])]),e("p",[s._v("生成证书：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("cfssl gencert "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-initca")]),s._v(" ca-csr.json "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" cfssljson "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bare")]),s._v(" ca -\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" *pem\nca-key.pem ca.pem\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("（2）使用自签 CA 签发 Etcd HTTPS 证书\n创建证书申请文件：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" server-csr.json"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n"CN": "etcd",\n"hosts": [\n"192.168.31.71",\n"192.168.31.72",\n"192.168.31.73"\n],\n"key": {\n"algo": "rsa",\n"size": 2048\n},\n"names": [\n{\n"C": "CN",\n"L": "BeiJing",\n"ST": "BeiJing"\n}\n]\n}\nEOF')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br")])]),e("p",[s._v("注：上述文件 hosts 字段中 IP 为所有 etcd 节点的集群内部通信 IP，一个都不能少！为了\n方便后期扩容可以多写几个预留的 IP。")]),s._v(" "),e("p",[s._v("生成证书：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("cfssl gencert "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ca")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ca.pem -ca-key"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ca-key.pem "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-config")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ca-config.json -\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("profile")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("www server-csr.json "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" cfssljson "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bare")]),s._v(" server\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" server*pem\nserver-key.pem server.pem\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"从-github-下载二进制文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#从-github-下载二进制文件"}},[s._v("#")]),s._v(" 从 Github 下载二进制文件")]),s._v(" "),e("p",[s._v("下载地址：https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-\nlinux-amd64.tar.gz")]),s._v(" "),e("h3",{attrs:{id:"部署-etcd-集群-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-etcd-集群-2"}},[s._v("#")]),s._v(" 部署 Etcd 集群")]),s._v(" "),e("p",[s._v("以下在节点 1 上操作，为简化操作，待会将节点 1 生成的所有文件拷贝到节点 2 和节点 3.")]),s._v(" "),e("p",[s._v("（1）创建工作目录并解压二进制包")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /opt/etcd/"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("bin,cfg,ssl"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" –p\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxvf etcd-v3.4.9-linux-amd64.tar.gz\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" etcd-v3.4.9-linux-amd64/"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("etcd,etcdctl"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" /opt/etcd/bin/\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("（2）创建 etcd 配置文件")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /opt/etcd/cfg/etcd.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n#[Member]\nETCD_NAME="etcd-1"\nETCD_DATA_DIR="/var/lib/etcd/default.etcd"\nETCD_LISTEN_PEER_URLS="https://192.168.31.71:2380"\nETCD_LISTEN_CLIENT_URLS="https://192.168.31.71:2379"\n#[Clustering]\nETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.31.71:2380"\nETCD_ADVERTISE_CLIENT_URLS="https://192.168.31.71:2379"\nETCD_INITIAL_CLUSTER="etcd-1=https://192.168.31.71:2380,etcd-\n2=https://192.168.31.72:2380,etcd-3=https://192.168.31.73:2380"\nETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"\nETCD_INITIAL_CLUSTER_STATE="new"\nEOF')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("p",[s._v("ETCD_NAME：节点名称，集群中唯一\nETCD_DATA_DIR：数据目录\nETCD_LISTEN_PEER_URLS：集群通信监听地址\nETCD_LISTEN_CLIENT_URLS：客户端访问监听地址\nETCD_INITIAL_ADVERTISE_PEER_URLS：集群通告地址\nETCD_ADVERTISE_CLIENT_URLS：客户端通告地址\nETCD_INITIAL_CLUSTER：集群节点地址\nETCD_INITIAL_CLUSTER_TOKEN：集群 Token\nETCD_INITIAL_CLUSTER_STATE：加入集群的当前状态，new 是新集群，existing 表示加入\n已有集群")]),s._v(" "),e("p",[s._v("（3）systemd 管理 etcd")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /usr/lib/systemd/system/etcd.service "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[Unit]\nDescription=Etcd Server\nAfter=network.target\nAfter=network-online.target\nWants=network-online.target\n[Service]\nType=notify\nEnvironmentFile=/opt/etcd/cfg/etcd.conf\nExecStart=/opt/etcd/bin/etcd \\\n--cert-file=/opt/etcd/ssl/server.pem \\\n--key-file=/opt/etcd/ssl/server-key.pem \\\n--peer-cert-file=/opt/etcd/ssl/server.pem \\\n--peer-key-file=/opt/etcd/ssl/server-key.pem \\\n--trusted-ca-file=/opt/etcd/ssl/ca.pem \\\n--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\\n--logger=zap\nRestart=on-failure\nLimitNOFILE=65536\n[Install]\nWantedBy=multi-user.target\nEOF")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br")])]),e("p",[s._v("（4）拷贝刚才生成的证书\n把刚才生成的证书拷贝到配置文件中的路径：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" ~/TLS/etcd/ca*pem ~/TLS/etcd/server*pem /opt/etcd/ssl/\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("（5）启动并设置开机启动")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("systemctl daemon-reload\nsystemctl start etcd\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" etcd\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("（6）将上面节点 1 所有生成的文件拷贝到节点 2 和节点 3")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" /opt/etcd/ root@192.168.31.72:/opt/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" /usr/lib/systemd/system/etcd.service\nroot@192.168.31.72:/usr/lib/systemd/system/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" /opt/etcd/ root@192.168.31.73:/opt/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" /usr/lib/systemd/system/etcd.service\nroot@192.168.31.73:/usr/lib/systemd/system/\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("然后在节点 2 和节点 3 分别修改 etcd.conf 配置文件中的节点名称和当前服务器 IP：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /opt/etcd/cfg/etcd.conf\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#[Member]")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_NAME")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcd-1"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改此处，节点 2 改为 etcd-2，节点 3 改为 etcd-3")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_DATA_DIR")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/lib/etcd/default.etcd"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_LISTEN_PEER_URLS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://192.168.31.71:2380"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改此处为当前服务器 IP")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_LISTEN_CLIENT_URLS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://192.168.31.71:2379"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改此处为当前服务器 IP")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#[Clustering]")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_ADVERTISE_PEER_URLS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://192.168.31.71:2380"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改此处为当前")]),s._v("\n服务器 IP\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_ADVERTISE_CLIENT_URLS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://192.168.31.71:2379"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改此处为当前服务器")]),s._v("\nIP\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_CLUSTER")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcd-1=https://192.168.31.71:2380,etcd-\n2=https://192.168.31.72:2380,etcd-3=https://192.168.31.73:2380"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_CLUSTER_TOKEN")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"etcd-cluster"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCD_INITIAL_CLUSTER_STATE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"new"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("p",[s._v("最后启动 etcd 并设置开机启动，同上。")]),s._v(" "),e("p",[s._v("（7）查看集群状态")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCDCTL_API")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" /opt/etcd/bin/etcdctl "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cacert")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/opt/etcd/ssl/ca.pem --\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cert")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/opt/etcd/ssl/server.pem "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--key")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/opt/etcd/ssl/server-key.pem --\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("endpoints")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://192.168.31.71:2379,https://192.168.31.72:2379,https://192.16\n8.31.73:2379"')]),s._v(" endpoint health\nhttps://192.168.31.71:2379 is healthy: successfully committed proposal: took "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(".154404ms\nhttps://192.168.31.73:2379 is healthy: successfully committed proposal: took "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(".044117ms\nhttps://192.168.31.72:2379 is healthy: successfully committed proposal: took "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(".000825ms\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("如果输出上面信息，就说明集群部署成功。如果有问题第一步先看日志：\n/var/log/message 或 journalctl -u etcd")]),s._v(" "),e("h2",{attrs:{id:"安装-docker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装-docker"}},[s._v("#")]),s._v(" 安装 Docker")]),s._v(" "),e("p",[s._v("下载地址：https://download.docker.com/linux/static/stable/x86_64/docker-\n19.03.9.tgz\n以下在所有节点操作。这里采用二进制安装，用 yum 安装也一样。")]),s._v(" "),e("p",[s._v("（1）解压二进制包")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxvf docker-19.03.9.tgz\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" docker/* /usr/bin\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("（2） systemd 管理 docker")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /usr/lib/systemd/system/docker.service "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[Unit]\nDescription=Docker Application Container Engine\nDocumentation=https://docs.docker.com\nAfter=network-online.target firewalld.service\nWants=network-online.target\n[Service]\nType=notify\nExecStart=/usr/bin/dockerd\nExecReload=/bin/kill -s HUP "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MAINPID")]),s._v("\nLimitNOFILE=infinity\nLimitNPROC=infinity\nLimitCORE=infinity\nTimeoutStartSec=0\nDelegate=yes\nKillMode=process\nRestart=on-failure\nStartLimitBurst=3\nStartLimitInterval=60s\n[Install]\nWantedBy=multi-user.target\nEOF")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br")])]),e("p",[s._v("（3）创建配置文件")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /etc/docker\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/docker/daemon.json "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n    "registry-mirrors": ["https://b9pmyelo.mirror.aliyuncs.com"]\n}\nEOF')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("registry-mirrors 阿里云镜像加速器")]),s._v(" "),e("p",[s._v("（4）启动并设置开机启动")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("systemctl daemon-reload\nsystemctl start "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v("\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h2",{attrs:{id:"部署-master-node"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-master-node"}},[s._v("#")]),s._v(" 部署 Master Node")]),s._v(" "),e("h3",{attrs:{id:"生成-kube-apiserver-证书"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#生成-kube-apiserver-证书"}},[s._v("#")]),s._v(" 生成 kube-apiserver 证书")]),s._v(" "),e("p",[s._v("（1）自签证书颁发机构（CA）")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ca-config.json"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n"signing": {\n"default": {\n"expiry": "87600h"\n},\n"profiles": {\n"kubernetes": {\n"expiry": "87600h",\n"usages": [\n"signing",\n"key encipherment",\n"server auth",\n"client auth"\n]\n}\n}\n}\n}\nEOF')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ca-csr.json"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n"CN": "kubernetes",\n"key": {\n"algo": "rsa",\n"size": 2048\n},\n"names": [\n{\n"C": "CN",\n"L": "Beijing",\n"ST": "Beijing",\n"O": "k8s",\n"OU": "System"\n}\n]\n}\nEOF')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br")])]),e("p",[s._v("（2）生成证书：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("cfssl gencert "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-initca")]),s._v(" ca-csr.json "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" cfssljson "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bare")]),s._v(" ca -\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" *pem\nca-key.pem ca.pem\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("（3）使用自签 CA 签发 kube-apiserver HTTPS 证书\n创建证书申请文件：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" TLS/k8s\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" server-csr.json"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n"CN": "kubernetes",\n"hosts": [\n"10.0.0.1",\n"127.0.0.1",\n"192.168.31.71",\n"192.168.31.72",\n"192.168.31.73",\n"192.168.31.74",\n"192.168.31.81",\n"192.168.31.82",\n"192.168.31.88",\n"kubernetes",\n"kubernetes.default",\n"kubernetes.default.svc",\n"kubernetes.default.svc.cluster",\n"kubernetes.default.svc.cluster.local"\n],\n"key": {\n"algo": "rsa",\n"size": 2048\n},\n"names": [\n{\n"C": "CN",\n"L": "BeiJing",\n"ST": "BeiJing",\n"O": "k8s",\n"OU": "System"\n}\n]\n}\nEOF')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br")])]),e("p",[s._v("生成证书：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("cfssl gencert "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ca")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ca.pem -ca-key"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ca-key.pem "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-config")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ca-config.json -\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("profile")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes server-csr.json "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" cfssljson "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bare")]),s._v(" server\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" server*pem\nserver-key.pem server.pem\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"从-github-下载二进制文件-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#从-github-下载二进制文件-2"}},[s._v("#")]),s._v(" 从 Github 下载二进制文件")]),s._v(" "),e("p",[s._v("下载地址：\nhttps://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-\n1.18.md#v1183\n注：打开链接你会发现里面有很多包，下载一个 server 包就够了，包含了 Master 和\nWorker Node 二进制文件。")]),s._v(" "),e("h3",{attrs:{id:"解压二进制包"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解压二进制包"}},[s._v("#")]),s._v(" 解压二进制包")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /opt/kubernetes/"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("bin,cfg,ssl,logs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxvf kubernetes-server-linux-amd64.tar.gz\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" kubernetes/server/bin\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" kubectl /usr/bin/\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h3",{attrs:{id:"部署-kube-apiserver"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-kube-apiserver"}},[s._v("#")]),s._v(" 部署 kube-apiserver")]),s._v(" "),e("ol",[e("li",[s._v("创建配置文件")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /opt/kubernetes/cfg/kube-apiserver.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\nKUBE_APISERVER_OPTS="--logtostderr=false '),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--v=2 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--log-dir=/opt/kubernetes/logs "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--etcdservers=https://192.168.31.71:2379,https://192.168.31.72:2379,https://192.168.3\n1.73:2379 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--bind-address=192.168.31.71 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--secure-port=6443 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--advertise-address=192.168.31.71 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--allow-privileged=true "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--service-cluster-ip-range=10.0.0.0/24 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--enable-admissionplugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestric\ntion "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--authorization-mode=RBAC,Node "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--enable-bootstrap-token-auth=true "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--token-auth-file=/opt/kubernetes/cfg/token.csv "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--service-node-port-range=30000-32767 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--tls-cert-file=/opt/kubernetes/ssl/server.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--client-ca-file=/opt/kubernetes/ssl/ca.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--etcd-cafile=/opt/etcd/ssl/ca.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--etcd-certfile=/opt/etcd/ssl/server.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--etcd-keyfile=/opt/etcd/ssl/server-key.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--audit-log-maxage=30 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--audit-log-maxbackup=3 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--audit-log-maxsize=100 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v('\n--audit-log-path=/opt/kubernetes/logs/k8s-audit.log"\nEOF')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br")])]),e("p",[s._v("注：上面两个\\ \\ 第一个是转义符，第二个是换行符，使用转义符是为了使用 EOF 保留换\n行符。\n–logtostderr：启用日志\n—v：日志等级\n–log-dir：日志目录\n–etcd-servers：etcd 集群地址\n–bind-address：监听地址\n–secure-port：https 安全端口\n–advertise-address：集群通告地址\n–allow-privileged：启用授权\n–service-cluster-ip-range：Service 虚拟 IP 地址段\n–enable-admission-plugins：准入控制模块\n–authorization-mode：认证授权，启用 RBAC 授权和节点自管理\n–enable-bootstrap-token-auth：启用 TLS bootstrap 机制\n–token-auth-file：bootstrap token 文件\n–service-node-port-range：Service nodeport 类型默认分配端口范围\n–kubelet-client-xxx：apiserver 访问 kubelet 客户端证书\n–tls-xxx-file：apiserver https 证书\n–etcd-xxxfile：连接 Etcd 集群证书\n–audit-log-xxx：审计日志")]),s._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[s._v("拷贝刚才生成的证书\n把刚才生成的证书拷贝到配置文件中的路径：")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/kubernetes/ssl/\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("启用 TLS Bootstrapping 机制")])]),s._v(" "),e("p",[s._v("TLS Bootstraping：Master apiserver 启用 TLS 认证后，Node 节点 kubelet 和 kube- proxy 要与 kube-apiserver 进行通信，必须使用 CA 签发的有效证书才可以，当 Node\n节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了\n简化流程，Kubernetes 引入了 TLS bootstraping 机制来自动颁发客户端证书，kubelet\n会以一个低权限用户自动向 apiserver 申请证书，kubelet 的证书由 apiserver 动态签署。\n所以强烈建议在 Node 上使用这种方式，目前主要用于 kubelet，kube-proxy 还是由我\n们统一颁发一个证书。")]),s._v(" "),e("p",[s._v("TLS bootstraping 工作流程：")]),s._v(" "),e("p",[s._v("创建上述配置文件中 token 文件：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /opt/kubernetes/cfg/token.csv "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\nc47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,"system:nodebootstrapper"\nEOF')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("格式：token，用户名，UID，用户组\ntoken 也可自行生成替换：\nhead -c 16 /dev/urandom | od -An -t x | tr -d ' '")]),s._v(" "),e("ol",{attrs:{start:"4"}},[e("li",[s._v("systemd 管理 apiserver")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /usr/lib/systemd/system/kube-apiserver.service "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[Unit]\nDescription=Kubernetes API Server\nDocumentation=https://github.com/kubernetes/kubernetes\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf\nExecStart=/opt/kubernetes/bin/kube-apiserver \\"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBE_APISERVER_OPTS")]),s._v("\nRestart=on-failure\n[Install]\nWantedBy=multi-user.target\nEOF")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("ol",{attrs:{start:"5"}},[e("li",[s._v("启动并设置开机启动")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("systemctl daemon-reload\nsystemctl start kube-apiserver\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" kube-apiserver\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ol",{attrs:{start:"6"}},[e("li",[s._v("授权 kubelet-bootstrap 用户允许请求证书")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl create clusterrolebinding kubelet-bootstrap "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--clusterrole")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("system:node-bootstrapper "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--user")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubelet-bootstrap\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"部署-kube-controller-manager"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-kube-controller-manager"}},[s._v("#")]),s._v(" 部署 kube-controller-manager")]),s._v(" "),e("ol",[e("li",[s._v("创建配置文件")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /opt/kubernetes/cfg/kube-controller-manager.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\nKUBE_CONTROLLER_MANAGER_OPTS="--logtostderr=false '),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--v=2 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--log-dir=/opt/kubernetes/logs "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--leader-elect=true "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--master=127.0.0.1:8080 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--bind-address=127.0.0.1 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--allocate-node-cidrs=true "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--cluster-cidr=10.244.0.0/16 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--service-cluster-ip-range=10.0.0.0/24 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--root-ca-file=/opt/kubernetes/ssl/ca.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v('\n--experimental-cluster-signing-duration=87600h0m0s"\nEOF')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("p",[s._v("–master：通过本地非安全本地端口 8080 连接 apiserver。\n–leader-elect：当该组件启动多个时，自动选举（HA）\n–cluster-signing-cert-file/–cluster-signing-key-file：自动为 kubelet 颁发证书\n的 CA，与 apiserver 保持一致")]),s._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[s._v("systemd 管理 controller-manager")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /usr/lib/systemd/system/kube-controller-manager.service "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[Unit]\nDescription=Kubernetes Controller Manager\nDocumentation=https://github.com/kubernetes/kubernetes\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf\nExecStart=/opt/kubernetes/bin/kube-controller-manager\n\\"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBE_CONTROLLER_MANAGER_OPTS")]),s._v("\nRestart=on-failure\n[Install]\nWantedBy=multi-user.target\nEOF")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("启动并设置开机启动")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("systemctl daemon-reload\nsystemctl start kube-controller-manager\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" kube-controller-manager\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"部署-kube-scheduler"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-kube-scheduler"}},[s._v("#")]),s._v(" 部署 kube-scheduler")]),s._v(" "),e("ol",[e("li",[s._v("创建配置文件")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /opt/kubernetes/cfg/kube-scheduler.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\nKUBE_SCHEDULER_OPTS="--logtostderr=false \\\n--v=2 \\\n--log-dir=/opt/kubernetes/logs \\\n--leader-elect \\\n--master=127.0.0.1:8080 \\\n--bind-address=127.0.0.1"\nEOF')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("–master：通过本地非安全本地端口 8080 连接 apiserver。\n–leader-elect：当该组件启动多个时，自动选举（HA）")]),s._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[s._v("systemd 管理 scheduler")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /usr/lib/systemd/system/kube-scheduler.service "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[Unit]\nDescription=Kubernetes Scheduler\nDocumentation=https://github.com/kubernetes/kubernetes\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf\nExecStart=/opt/kubernetes/bin/kube-scheduler \\"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBE_SCHEDULER_OPTS")]),s._v("\nRestart=on-failure\n[Install]\nWantedBy=multi-user.target\nEOF")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("启动并设置开机启动")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("systemctl daemon-reload\nsystemctl start kube-scheduler\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" kube-scheduler\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ol",{attrs:{start:"4"}},[e("li",[s._v("查看集群状态")])]),s._v(" "),e("p",[s._v("所有组件都已经启动成功，通过 kubectl 工具查看当前集群组件状态：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl get cs\nNAME STATUS MESSAGE ERROR\nscheduler Healthy ok\ncontroller-manager Healthy ok\netcd-2 Healthy "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"health"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\netcd-1 Healthy "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"health"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\netcd-0 Healthy "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"health"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("如上输出说明 Master 节点组件运行正常。")]),s._v(" "),e("h2",{attrs:{id:"部署-worker-node"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-worker-node"}},[s._v("#")]),s._v(" 部署 Worker Node")]),s._v(" "),e("p",[s._v("下面还是在 Master Node 上操作，即同时作为 Worker Node")]),s._v(" "),e("h3",{attrs:{id:"创建工作目录并拷贝二进制文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建工作目录并拷贝二进制文件"}},[s._v("#")]),s._v(" 创建工作目录并拷贝二进制文件")]),s._v(" "),e("p",[s._v("在所有 worker node 创建工作目录：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /opt/kubernetes/"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("bin,cfg,ssl,logs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("从 master 节点拷贝：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" kubernetes/server/bin\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" kubelet kube-proxy /opt/kubernetes/bin "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 本地拷贝")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h3",{attrs:{id:"部署-kubelet"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-kubelet"}},[s._v("#")]),s._v(" 部署 kubelet")]),s._v(" "),e("ol",[e("li",[s._v("创建配置文件")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /opt/kubernetes/cfg/kubelet.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\nKUBELET_OPTS="--logtostderr=false '),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--v=2 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--log-dir=/opt/kubernetes/logs "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--hostname-override=k8s-master "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--network-plugin=cni "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--config=/opt/kubernetes/cfg/kubelet-config.yml "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--cert-dir=/opt/kubernetes/ssl "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v('\n--pod-infra-container-image=lizhenliang/pause-amd64:3.0"\nEOF')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("p",[s._v("–hostname-override：显示名称，集群中唯一\n–network-plugin：启用 CNI –kubeconfig：空路径，会自动生成，后面用于连接 apiserver –bootstrap-kubeconfig：首次启动向 apiserver 申请证书\n–config：配置参数文件\n–cert-dir：kubelet 证书生成目录\n–pod-infra-container-image：管理 Pod 网络容器的镜像")]),s._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[s._v("配置参数文件")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /opt/kubernetes/cfg/kubelet-config.yml "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\nkind: KubeletConfiguration\napiVersion: kubelet.config.k8s.io/v1beta1\naddress: 0.0.0.0\nport: 10250\nreadOnlyPort: 10255\ncgroupDriver: cgroupfs\nclusterDNS:\n- 10.0.0.2\nclusterDomain: cluster.local\nfailSwapOn: false\nauthentication:\nanonymous:\nenabled: false\nwebhook:\ncacheTTL: 2m0s\nenabled: true\nx509:\nclientCAFile: /opt/kubernetes/ssl/ca.pem\nauthorization:\nmode: Webhook\nwebhook:\ncacheAuthorizedTTL: 5m0s\ncacheUnauthorizedTTL: 30s\nevictionHard:\nimagefs.available: 15%\nmemory.available: 100Mi\nnodefs.available: 10%\nnodefs.inodesFree: 5%\nmaxOpenFiles: 1000000\nmaxPods: 110\nEOF")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("生成 bootstrap.kubeconfig 文件")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("KUBE_APISERVER")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://192.168.31.71:6443"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# apiserver IP:PORT")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TOKEN")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"c47ffb939f5ca36231d9e3121a252940"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 与 token.csv 里保持一致")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成 kubelet bootstrap kubeconfig 配置文件")]),s._v("\nkubectl config set-cluster kubernetes "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--certificate-authority"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/opt/kubernetes/ssl/ca.pem "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--embed-certs"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--server")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${KUBE_APISERVER}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bootstrap.kubeconfig\nkubectl config set-credentials "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubelet-bootstrap"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--token")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TOKEN}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bootstrap.kubeconfig\nkubectl config set-context default "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--user")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubelet-bootstrap"')]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bootstrap.kubeconfig\nkubectl config use-context default "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("bootstrap.kubeconfig\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("p",[s._v("拷贝到配置文件路径：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" bootstrap.kubeconfig /opt/kubernetes/cfg\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ol",{attrs:{start:"4"}},[e("li",[s._v("systemd 管理 kubelet")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /usr/lib/systemd/system/kubelet.service "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[Unit]\nDescription=Kubernetes Kubelet\nAfter=docker.service\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kubelet.conf\nExecStart=/opt/kubernetes/bin/kubelet \\"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_OPTS")]),s._v("\nRestart=on-failure\nLimitNOFILE=65536\n[Install]\nWantedBy=multi-user.target\nEOF")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("ol",{attrs:{start:"5"}},[e("li",[s._v("启动并设置开机启动")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("systemctl daemon-reload\nsystemctl start kubelet\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" kubelet\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"批准-kubelet-证书申请并加入集群"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#批准-kubelet-证书申请并加入集群"}},[s._v("#")]),s._v(" 批准 kubelet 证书申请并加入集群")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看 kubelet 证书请求")]),s._v("\nkubectl get csr\nNAME AGE SIGNERNAME\nREQUESTOR CONDITION\nnode-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A 6m3s\nkubernetes.io/kube-apiserver-client-kubelet kubelet-bootstrap Pending\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 批准申请")]),s._v("\nkubectl certificate approve node-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--\nK6M4G7bjhk8A\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看节点")]),s._v("\nkubectl get "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("p",[s._v("注：由于网络插件还没有部署，节点会没有准备就绪 NotReady")]),s._v(" "),e("h3",{attrs:{id:"部署-kube-proxy"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-kube-proxy"}},[s._v("#")]),s._v(" 部署 kube-proxy")]),s._v(" "),e("ol",[e("li",[s._v("创建配置文件")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /opt/kubernetes/cfg/kube-proxy.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\nKUBE_PROXY_OPTS="--logtostderr=false '),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--v=2 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v("\n--log-dir=/opt/kubernetes/logs "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v('\n--config=/opt/kubernetes/cfg/kube-proxy-config.yml"\nEOF')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("ol",{attrs:{start:"2"}},[e("li",[s._v("配置参数文件")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /opt/kubernetes/cfg/kube-proxy-config.yml "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\nkind: KubeProxyConfiguration\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nbindAddress: 0.0.0.0\nmetricsBindAddress: 0.0.0.0:10249\nclientConnection:\nkubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig\nhostnameOverride: k8s-master\nclusterCIDR: 10.0.0.0/24\nEOF")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("生成 kube-proxy.kubeconfig 文件\n生成 kube-proxy 证书：")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 切换工作目录")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" TLS/k8s\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建证书请求文件")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" kube-proxy-csr.json"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\n{\n"CN": "system:kube-proxy",\n"hosts": [],\n"key": {\n"algo": "rsa",\n"size": 2048\n},\n"names": [\n{\n"C": "CN",\n"L": "BeiJing",\n"ST": "BeiJing",\n"O": "k8s",\n"OU": "System"\n}\n]\n}\nEOF')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成证书")]),s._v("\ncfssl gencert "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ca")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ca.pem -ca-key"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ca-key.pem "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-config")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ca-config.json -\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("profile")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes kube-proxy-csr.json "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" cfssljson "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-bare")]),s._v(" kube-proxy\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" kube-proxy*pem\nkube-proxy-key.pem kube-proxy.pem\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br")])]),e("p",[s._v("生成 kubeconfig 文件：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("KUBE_APISERVER")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"https://192.168.31.71:6443"')]),s._v("\nkubectl config set-cluster kubernetes "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--certificate-authority"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/opt/kubernetes/ssl/ca.pem "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--embed-certs"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--server")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${KUBE_APISERVER}")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-proxy.kubeconfig\nkubectl config set-credentials kube-proxy "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--client-certificate"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./kube-proxy.pem "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--client-key"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("./kube-proxy-key.pem "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--embed-certs"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-proxy.kubeconfig\nkubectl config set-context default "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--user")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-proxy "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-proxy.kubeconfig\nkubectl config use-context default "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-proxy.kubeconfig\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("p",[s._v("拷贝到配置文件指定路径：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" kube-proxy.kubeconfig /opt/kubernetes/cfg/\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ol",{attrs:{start:"4"}},[e("li",[s._v("systemd 管理 kube-proxy")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /usr/lib/systemd/system/kube-proxy.service "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[Unit]\nDescription=Kubernetes Proxy\nAfter=network.target\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf\nExecStart=/opt/kubernetes/bin/kube-proxy \\"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBE_PROXY_OPTS")]),s._v("\nRestart=on-failure\nLimitNOFILE=65536\n[Install]\nWantedBy=multi-user.target\nEOF")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("ol",{attrs:{start:"5"}},[e("li",[s._v("启动并设置开机启动")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("systemctl daemon-reload\nsystemctl start kube-proxy\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" kube-proxy\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"部署-cni-网络"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署-cni-网络"}},[s._v("#")]),s._v(" 部署 CNI 网络")]),s._v(" "),e("p",[s._v("先准备好 CNI 二进制文件：\n下载地址：\nhttps://github.com/containernetworking/plugins/releases/download/v0.8.6/cni- plugins-linux-amd64-v0.8.6.tgz\n解压二进制包并移动到默认工作目录：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /opt/cni/bin\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("tar")]),s._v(" zxvf cni-plugins-linux-amd64-v0.8.6.tgz "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-C")]),s._v(" /opt/cni/bin\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("部署 CNI 网络：")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v("\nhttps://raw.githubusercontent.com/coreos/flannel/master/Documentation/kubeflannel.yml\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s#quay.io/coreos/flannel:.*-amd64#lizhenliang/flannel:v0.12.0-\namd64#g"')]),s._v(" kube-flannel.yml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("默认镜像地址无法访问，修改为 docker hub 镜像仓库。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl apply "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" kube-flannel.yml\nkubectl get pods "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" kube-system\nkubectl get "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("部署好网络插件，Node 准备就绪。")]),s._v(" "),e("h3",{attrs:{id:"授权-apiserver-访问-kubelet"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#授权-apiserver-访问-kubelet"}},[s._v("#")]),s._v(" 授权 apiserver 访问 kubelet")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" apiserver-to-kubelet-rbac.yaml"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\nannotations:\nrbac.authorization.kubernetes.io/autoupdate: "true"\nlabels:\nkubernetes.io/bootstrapping: rbac-defaults\nname: system:kube-apiserver-to-kubelet\nrules:\n- apiGroups:\n- ""\nresources:\n- nodes/proxy\n- nodes/stats\n- nodes/log\n- nodes/spec\n- nodes/metrics\n- pods/log\nverbs:\n- "*"\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\nname: system:kube-apiserver\nnamespace: ""\nroleRef:\napiGroup: rbac.authorization.k8s.io\nkind: ClusterRole\nname: system:kube-apiserver-to-kubelet\nsubjects:\n- apiGroup: rbac.authorization.k8s.io\nkind: User\nname: kubernetes\nEOF')]),s._v("\nkubectl apply "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" apiserver-to-kubelet-rbac.yaml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br")])]),e("h3",{attrs:{id:"新增加-worker-node"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#新增加-worker-node"}},[s._v("#")]),s._v(" 新增加 Worker Node")]),s._v(" "),e("ol",[e("li",[s._v("拷贝已部署好的 Node 相关文件到新节点\n在 master 节点将 Worker Node 涉及文件拷贝到新节点 192.168.31.72/73")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" /opt/kubernetes root@192.168.31.72:/opt/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" /usr/lib/systemd/system/"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("kubelet,kube-proxy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(".service\nroot@192.168.31.72:/usr/lib/systemd/system\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" /opt/cni/ root@192.168.31.72:/opt/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" /opt/kubernetes/ssl/ca.pem root@192.168.31.72:/opt/kubernetes/ssl\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ol",{attrs:{start:"2"}},[e("li",[s._v("删除 kubelet 证书和 kubeconfig 文件")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" /opt/kubernetes/cfg/kubelet.kubeconfig\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" /opt/kubernetes/ssl/kubelet*\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("注：这几个文件是证书申请审批后自动生成的，每个 Node 不同，必须删除重新生成。")]),s._v(" "),e("ol",{attrs:{start:"3"}},[e("li",[s._v("修改主机名")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /opt/kubernetes/cfg/kubelet.conf\n--hostname-override"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("k8s-node1\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /opt/kubernetes/cfg/kube-proxy-config.yml\nhostnameOverride: k8s-node1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ol",{attrs:{start:"4"}},[e("li",[s._v("启动并设置开机启动")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("systemctl daemon-reload\nsystemctl start kubelet\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" kubelet\nsystemctl start kube-proxy\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" kube-proxy\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ol",{attrs:{start:"5"}},[e("li",[s._v("在 Master 上批准新 Node kubelet 证书申请")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl get csr\nNAME AGE SIGNERNAME\nREQUESTOR CONDITION\nnode-csr-4zTjsaVSrhuyhIGqsefxzVoZDCNKei-aE2jyTP81Uro 89s\nkubernetes.io/kube-apiserver-client-kubelet kubelet-bootstrap Pending\nkubectl certificate approve node-csr-4zTjsaVSrhuyhIGqsefxzVoZDCNKeiaE2jyTP81Uro\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("ol",{attrs:{start:"6"}},[e("li",[s._v("查看 Node 状态")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("Kubectl get "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("Node2（192.168.31.73 ）节点同上。记得修改主机名！")])])}),[],!1,null,null,null);a.default=n.exports}}]);